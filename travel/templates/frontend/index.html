<!DOCTYPE html>
<html>
<head>
  <title>VTravelBuddy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; }
    .app { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    header { text-align: center; margin-bottom: 2rem; }
    header h1 { font-size: 3rem; font-weight: 800; margin-bottom: 0.5rem; text-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    
    .auth-section { max-width: 400px; margin: 100px auto; background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 20px; }
    .input-field { width: 100%; padding: 1rem; margin: 1rem 0; border: none; border-radius: 12px; font-size: 1rem; background: rgba(255,255,255,0.2); color: white; }
    .btn { width: 100%; padding: 1rem; margin: 0.5rem 0; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
    .btn-primary { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
    .btn-secondary { background: rgba(255,255,255,0.2); color: white; }
    
    .tabs { display: flex; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 0.5rem; margin-bottom: 2rem; }
    .tab { flex: 1; padding: 1rem; background: transparent; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .tab.active { background: rgba(255,255,255,0.2); }
    
    .tab-content { display: none; background: rgba(255,255,255,0.1); border-radius: 20px; padding: 2rem; }
    .tab-content.active { display: block; }
    
    .section { margin-bottom: 2rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.75rem; font-size: 1.2rem; }
    input { width: 100%; padding: 1.2rem; border: 2px solid rgba(255,255,255,0.3); border-radius: 16px; font-size: 1.1rem; background: rgba(255,255,255,0.1); color: white; }
    
    .ride { background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem; }
    .ride-route { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
    .ride-details { display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 1rem; }
    .book-btn { width: 100%; padding: 1rem; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 12px; font-size: 1.1rem; cursor: pointer; }
    
    .filters { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
    .filter-select { padding: 0.8rem; border-radius: 12px; background: rgba(255,255,255,0.1); color: white; border: none; }
    
    .message { padding: 1rem; border-radius: 12px; margin-bottom: 1rem; font-weight: 600; text-align: center; }
    .success { background: rgba(40,167,69,0.3); }
    .error { background: rgba(220,38,38,0.3); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üöó VTravelBuddy</h1>
      <p>Full marketplace ride-sharing for VIT students</p>
    </header>

    <!-- AUTH SECTION -->
    <div id="authSection" class="auth-section">
      <h2>Login / Register</h2>
      <input id="email" class="input-field" placeholder="laya@gmail.com" />
      <input id="password" class="input-field" type="password" placeholder="password" />
      <button class="btn btn-primary" onclick="login()">Login</button>
      <button class="btn btn-secondary" onclick="registerUser()">Register</button>
      <div id="authMessage"></div>
    </div>

    <!-- MAIN APP -->
    <div id="appSection" style="display: none;">
      <div class="tabs">
        <button class="tab active" onclick="showTab('home')">üè† Home</button>
        <button class="tab" onclick="showTab('bookings')">üìã My Bookings</button>
        <button class="tab" onclick="showTab('rides')">üöô My Rides</button>
        <button class="tab" onclick="toggleDriverMode()">üîÑ Driver Mode</button>
        <button class="tab" onclick="logout()">üö™ Logout</button>
      </div>

      <!-- HOME TAB -->
      <div id="homeTab" class="tab-content active">
        <div class="section">
          <label>Your Name</label>
          <input id="studentName" placeholder="Laya, 22BCEXXXX" />
        </div>
        <div class="filters">
          <select id="timeFilter" class="filter-select" onchange="filterRides()">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="tomorrow">Tomorrow</option>
          </select>
          <select id="priceFilter" class="filter-select" onchange="filterRides()">
            <option value="all">All Prices</option>
            <option value="0-50">‚Çπ0-50</option>
            <option value="50-100">‚Çπ50-100</option>
          </select>
          <select id="sortFilter" class="filter-select" onchange="filterRides()">
            <option value="newest">Newest First</option>
            <option value="price-low">Price: Low-High</option>
            <option value="price-high">Price: High-Low</option>
          </select>
        </div>
        <div id="ridesSection">
          <h2>Available Rides</h2>
          <div>Loading rides...</div>
        </div>
      </div>

      <!-- MY BOOKINGS TAB -->
      <div id="bookingsTab" class="tab-content">
        <h2>üìã My Bookings</h2>
        <div id="bookingsList">Loading your bookings...</div>
      </div>

      <!-- MY RIDES TAB -->
      <div id="ridesTab" class="tab-content">
        <h2>üöô My Posted Rides</h2>
        <button class="btn btn-primary" onclick="showPostRideForm()">+ Post New Ride</button>
        <div id="ridesList">Loading your rides...</div>
        <div id="postRideForm" style="display: none;">
          <h3>Post New Ride</h3>
          <input id="origin" placeholder="Origin (VIT Hostel)" />
          <input id="destinationId" placeholder="Destination ID (1)" />
          <input id="seats" type="number" placeholder="Available seats" />
          <input id="price" type="number" placeholder="Price per seat" />
          <input id="departureTime" type="datetime-local" />
          <button class="btn btn-primary" onclick="postRide()">Post Ride</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let token = localStorage.getItem('token');
    let allRides = [];
    let filteredRides = [];
    let isDriverMode = false;

    if (token) {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
      loadData();
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        const res = await fetch('/api/token/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: email, password })
        });
        const data = await res.json();
        
        if (res.ok) {
          localStorage.setItem('token', data.access);
          localStorage.setItem('refresh', data.refresh);
          document.getElementById('authSection').style.display = 'none';
          document.getElementById('appSection').style.display = 'block';
          loadData();
        } else {
          showMessage('Login failed: ' + data.detail, 'error');
        }
      } catch (error) {
        showMessage('Network error', 'error');
      }
    }

    async function registerUser() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        const res = await fetch('/api/register/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: email, email, password })
        });
        const data = await res.json();
        showMessage(data.message, 'success');
      } catch (error) {
        showMessage('Registration failed', 'error');
      }
    }

    async function loadData() {
      try {
        const [ridesRes, bookingsRes, myRidesRes] = await Promise.all([
          fetch('/api/rides/'),
          fetch('/api/my-bookings/', { headers: { 'Authorization': `Bearer ${token}` } }),
          fetch('/api/my-rides/', { headers: { 'Authorization': `Bearer ${token}` } })
        ]);
        
        allRides = await ridesRes.json();
        filteredRides = allRides;
        renderRides();
        
        const bookings = await bookingsRes.json();
        document.getElementById('bookingsList').innerHTML = bookings.length 
          ? bookings.map(b => `<div class="ride"><strong>${b.student_name}</strong> ‚Üí ${b.ride_details} (‚Çπ${b.total_price})</div>`).join('')
          : '<p>No bookings yet</p>';
          
        const myRides = await myRidesRes.json();
        document.getElementById('ridesList').innerHTML = myRides.length && !myRides.message
          ? myRides.map(r => `<div class="ride">${r.origin} ‚Üí ${r.destination_name} (${r.available_seats} seats)</div>`).join('')
          : '<p>No rides posted or you are not a driver</p>';
      } catch (error) {
        console.error('Load error:', error);
      }
    }

    function renderRides() {
      const container = document.getElementById('ridesSection');
      container.innerHTML = `
        <h2>Available Rides (${filteredRides.length})</h2>
        ${filteredRides.map(ride => `
          <div class="ride">
            <div class="ride-route">
              <span style="color: #10b981;">${ride.origin}</span> 
              ‚Üí 
              <span style="color: #ef4444;">${ride.destination_name}</span>
            </div>
            <div class="ride-details">
              <div>ü™ë ${ride.available_seats} seats</div>
              <div>üí∞ ‚Çπ${ride.price_per_seat}</div>
              <div>üïí ${new Date(ride.departure_time).toLocaleString()}</div>
            </div>
            ${ride.available_seats > 0 ? `
              <button class="book-btn" onclick="bookRide(${ride.id})">Book Now (‚Çπ${ride.price_per_seat})</button>
            ` : '<p style="color: #fbbf24;">No seats available</p>'}
          </div>
        `).join('') || '<p>No rides match your filters. <a href="/admin/">Add rides in admin</a></p>'}
      `;
    }

    function filterRides() {
      let rides = [...allRides];
      
      // Time filter
      const timeFilter = document.getElementById('timeFilter').value;
      const now = new Date();
      if (timeFilter === 'today') rides = rides.filter(r => new Date(r.departure_time).toDateString() === now.toDateString());
      if (timeFilter === 'tomorrow') rides = rides.filter(r => new Date(r.departure_time).toDateString() === new Date(now.getTime() + 86400000).toDateString());
      
      // Price filter
      const priceFilter = document.getElementById('priceFilter').value;
      if (priceFilter === '0-50') rides = rides.filter(r => r.price_per_seat <= 50);
      if (priceFilter === '50-100') rides = rides.filter(r => r.price_per_seat > 50 && r.price_per_seat <= 100);
      
      // Sort
      const sortFilter = document.getElementById('sortFilter').value;
      if (sortFilter === 'price-low') rides.sort((a, b) => a.price_per_seat - b.price_per_seat);
      if (sortFilter === 'price-high') rides.sort((a, b) => b.price_per_seat - a.price_per_seat);
      
      filteredRides = rides;
      renderRides();
    }

    async function bookRide(rideId) {
      const studentName = document.getElementById('studentName').value.trim();
      if (!studentName) return showMessage('Enter your name first!', 'error');
      
      try {
        const res = await fetch('/api/bookings/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ride_id: rideId, student_name: studentName })
        });
        const data = await res.json();
        
        if (res.ok) {
          showMessage(data.message, 'success');
          loadData();
        } else {
          showMessage(data.error, 'error');
        }
      } catch (error) {
        showMessage('Booking failed', 'error');
      }
    }

    async function postRide() {
      const rideData = {
        origin: document.getElementById('origin').value,
        destination_id: parseInt(document.getElementById('destinationId').value),
        available_seats: parseInt(document.getElementById('seats').value),
        price_per_seat: parseFloat(document.getElementById('price').value),
        departure_time: document.getElementById('departureTime').value
      };
      
      try {
        const res = await fetch('/api/post-ride/', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(rideData)
        });
        const data = await res.json();
        
        if (res.ok) {
          showMessage(data.message, 'success');
          document.getElementById('postRideForm').style.display = 'none';
          loadData();
        } else {
          showMessage(data.error, 'error');
        }
      } catch (error) {
        showMessage('Failed to post ride', 'error');
      }
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');
      event.target.classList.add('active');
      if (tabName === 'bookings' || tabName === 'rides') loadData();
    }

    function showPostRideForm() {
      document.getElementById('postRideForm').style.display = 'block';
    }

    function toggleDriverMode() {
      isDriverMode = !isDriverMode;
      localStorage.setItem('isDriver', isDriverMode);
      loadData();
    }

    function showMessage(text, type) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      document.querySelector('.app').appendChild(msg);
      setTimeout(() => msg.remove(), 5000);
    }

    function logout() {
      localStorage.clear();
      location.reload();
    }
  </script>
</body>
</html>
